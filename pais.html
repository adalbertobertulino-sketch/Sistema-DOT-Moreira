<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema DOT Moreira - Pais</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="app.js"></script>
</head>
<body>
  <div id="topbar"></div>
  <div class="container">

    <div class="card">
      <h2>Área dos Pais</h2>
      <p class="small">
        Aqui o responsável vê apenas os alunos cujo email dele foi cadastrado no campo
        <b>Emails dos pais</b> do aluno.
      </p>
      <div id="info" class="small">Carregando…</div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Meus alunos</h2>
      <div id="kids" class="small">Carregando…</div>
    </div>

  </div>

  <script>
    let state={me:null,user:null};

    async function renderKids(){
      const email = (state.me.email || "").toLowerCase().trim();
      const kids = await listMyChildren(email);

      if(!kids.length){
        $("#kids").innerHTML = "Nenhum aluno vinculado ao seu email.";
        return;
      }

      // Para cada aluno, buscar notas + link PDF
      let html = "";
      for(const k of kids){
        const grades = await listGradesForStudent(k.id);
        html += `
          <div style="padding:12px 0;border-bottom:1px solid #e5e7eb">
            <b>${k.name}</b> <span class="badge">${k.turma}</span><br/>
            <span class="small">RA: ${k.ra || "-"}</span><br/>
            <div style="margin-top:8px" class="small">
              ${grades.length ? grades.map(g => `
                <div style="padding:6px 0">
                  <b>${g.bimestre}º bimestre:</b>
                  N1 ${g.nota1 ?? "-"} | N2 ${g.nota2 ?? "-"} | Média ${g.media ?? "-"}
                  ${g.pdfUrl ? ` | <a href="${g.pdfUrl}" target="_blank">Abrir PDF</a>` : ""}
                </div>
              `).join("") : "Sem notas/boletim cadastrados ainda."}
            </div>
          </div>
        `;
      }

      $("#kids").innerHTML = html;
    }

    (async function(){
      renderTopbar("pais");
      const {user,me}=await requireAuth();
      state.user=user; state.me=me;

      $("#info").innerHTML = `
        <b>Logado como:</b> ${me.email}<br/>
        <b>Roles:</b> ${(me.roles||[]).join(", ")}
      `;

      await renderKids();
    })();
  </script>
</body>
</html>
