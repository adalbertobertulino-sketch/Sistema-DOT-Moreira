<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema DOT Moreira - Admin</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="app.js"></script>
</head>
<body>
  <div id="topbar"></div>
  <div class="container">

    <div class="card">
      <h2>Administração</h2>
      <p class="small" id="who">Carregando…</p>
      <p class="small">
        ⚠️ Para este modo funcionar com segurança, você define o primeiro admin manualmente em
        <b>Firestore → users → SEU_UID → roles: ["admin","dot"]</b>.
      </p>
    </div>

    <div class="grid" style="margin-top:14px;">
      <div class="card">
        <h2>Convidar por email (vira role ao logar)</h2>
        <div class="field">
          <label>Email</label>
          <input id="email" placeholder="ex: professor@escola.com" />
        </div>
        <div class="field">
          <label>Role para aplicar</label>
          <select id="role">
            <option value="admin">admin</option>
            <option value="dot">dot</option>
            <option value="monitor">monitor</option>
            <option value="parent">parent</option>
          </select>
        </div>
        <button class="btn primary" onclick="invite()">Criar convite</button>
        <p class="small" id="msg"></p>
      </div>

      <div class="card">
        <h2>Alterar roles por UID (usuário já logou)</h2>
        <div class="field">
          <label>UID</label>
          <input id="uid" placeholder="Cole o UID do usuário" />
        </div>
        <div class="field">
          <label>Roles (separadas por vírgula)</label>
          <input id="roles" placeholder="admin,dot" />
        </div>
        <button class="btn primary" onclick="setRoles()">Salvar roles</button>
        <p class="small" id="msg2"></p>
      </div>
    </div>

  </div>

  <script>
    let state={me:null,user:null};

    async function invite(){
      try{
        $("#msg").innerText="Salvando…";
        await createAdminInvite($("#email").value, $("#role").value, state.me);
        $("#msg").innerText="✅ Convite criado. Quando a pessoa logar, a role será aplicada.";
      }catch(e){
        $("#msg").innerText="❌ "+e.message;
      }
    }

    async function setRoles(){
      try{
        $("#msg2").innerText="Salvando…";
        const roles = ($("#roles").value||"").split(",").map(s=>s.trim()).filter(Boolean);
        await setUserRoles($("#uid").value.trim(), roles, state.me);
        $("#msg2").innerText="✅ Roles atualizadas!";
      }catch(e){
        $("#msg2").innerText="❌ "+e.message;
      }
    }

    (async function(){
      renderTopbar("admin");
      const {user,me}=await requireAuth();
      state.user=user; state.me=me;

      if(!hasRole(me.roles,"admin")){
        $("#who").innerHTML = `<span class="badge red">Acesso negado</span> Você não é admin.`;
        return;
      }

      $("#who").innerHTML = `
        <span class="badge green">ADMIN</span><br/>
        <b>${me.name || "-"}</b><br/>
        ${me.email}<br/>
        UID: ${me.uid}<br/>
        Roles: ${(me.roles||[]).join(", ")}
      `;
    })();
  </script>
</body>
</html>
