<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de Alunos – Sistema DOT</title>
</head>
<body>

<h2>Cadastro de Alunos</h2>
<p id="status">Verificando acesso...</p>

<form id="formAluno" style="display:none">
  <label>Nome completo *</label><br>
  <input type="text" id="nome" required><br><br>

  <label>Turma *</label><br>
  <input type="text" id="turma" required><br><br>

  <label>Matrícula (opcional)</label><br>
  <input type="text" id="matricula"><br><br>

  <button type="submit">Cadastrar aluno</button>
</form>

<hr>

<h3>Alunos cadastrados</h3>
<ul id="lista"></ul>

<br>
<button onclick="window.location.href='dashboard.html'">Voltar</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    getDocs, 
    serverTimestamp,
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMr2MIbnPw7k3W6WVmWwY-Pa3VgG0z1qk",
    authDomain: "sistema-dot.firebaseapp.com",
    projectId: "sistema-dot",
    storageBucket: "sistema-dot.firebasestorage.app",
    messagingSenderId: "1003611331429",
    appId: "1:1003611331429:web:2b55b32379b447e3059f8c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const form = document.getElementById("formAluno");
  const lista = document.getElementById("lista");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      statusEl.textContent = "Usuário sem perfil.";
      return;
    }

    const role = snap.data().role || [];

    if (!role.includes("dot") && !role.includes("admin")) {
      alert("Apenas professor DOT ou ADMIN pode cadastrar alunos.");
      window.location.href = "dashboard.html";
      return;
    }

    statusEl.textContent = "Acesso liberado para cadastro.";
    form.style.display = "block";
    carregarAlunos();
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const nome = document.getElementById("nome").value.trim();
    const turma = document.getElementById("turma").value.trim();
    const matricula = document.getElementById("matricula").value.trim();

    if (!nome || !turma) {
      alert("Nome e turma são obrigatórios.");
      return;
    }

    await addDoc(collection(db, "alunos"), {
      nome,
      turma,
      matricula: matricula || null,
      criadoEm: serverTimestamp()
    });

    form.reset();
    carregarAlunos();
  });

  async function carregarAlunos() {
    lista.innerHTML = "";
    const snap = await getDocs(collection(db, "alunos"));

    snap.forEach(doc => {
      const a = doc.data();
      const li = document.createElement("li");

      li.textContent =
        a.nome +
        " | Turma: " + a.turma +
        (a.matricula ? " | Matrícula: " + a.matricula : "");

      lista.appendChild(li);
    });
  }
</script>

</body>
</html>
