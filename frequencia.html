<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema DOT Moreira - Frequência</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="app.js"></script>
</head>
<body>
  <div id="topbar"></div>
  <div class="container">

    <div class="card">
      <h2>Frequência diária / faltas por aula</h2>
      <div class="row">
        <div class="field" style="min-width:240px;">
          <label>Data</label>
          <input id="date" type="date" />
        </div>
        <button class="btn ghost" onclick="loadDay()">Carregar</button>
      </div>
      <p class="small">Você pode marcar Presença/Falta e também quantas aulas faltou no dia.</p>
      <p class="small" id="msg"></p>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Alunos</h2>
      <div id="grid" class="small">Carregando…</div>
    </div>

  </div>

  <script>
    let state = { me:null, user:null, students:[] };

    function todayISO(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${d.getFullYear()}-${mm}-${dd}`;
    }

    async function loadDay(){
      const dateISO = $("#date").value || todayISO();
      $("#date").value = dateISO;
      $("#msg").innerText = "Carregando frequência…";

      const att = await listAttendanceByDate(dateISO);
      const map = new Map(att.map(a => [a.studentId, a]));

      $("#grid").innerHTML = `
        <table class="table">
          <thead>
            <tr><th>Aluno</th><th>Turma</th><th>Status</th><th>Faltas (aulas)</th><th>Ação</th></tr>
          </thead>
          <tbody>
            ${state.students.map(s => {
              const a = map.get(s.id) || {};
              const status = a.status || "present";
              const faltas = a.faltasAulas || 0;
              return `
                <tr>
                  <td>${s.name}</td>
                  <td>${s.turma}</td>
                  <td>
                    <select id="st_${s.id}">
                      <option value="present" ${status==="present"?"selected":""}>Presente</option>
                      <option value="absent" ${status==="absent"?"selected":""}>Faltou</option>
                    </select>
                  </td>
                  <td><input id="fa_${s.id}" type="number" min="0" value="${faltas}" style="width:90px"/></td>
                  <td><button class="btn ghost" onclick="saveOne('${s.id}')">Salvar</button></td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      `;

      $("#msg").innerText = "✅ Carregado.";
    }

    async function saveOne(studentId){
      try{
        const dateISO = $("#date").value || todayISO();
        const status = document.getElementById("st_"+studentId).value;
        const faltas = document.getElementById("fa_"+studentId).value;
        await saveAttendance(studentId, dateISO, status, faltas, state.me);
        $("#msg").innerText = "✅ Salvo!";
      }catch(e){
        $("#msg").innerText = "❌ " + e.message;
      }
    }

    (async function(){
      renderTopbar("frequencia");
      const { user, me } = await requireAuth();
      state.user=user; state.me=me;

      state.students = await listStudents();
      $("#date").value = todayISO();
      await loadDay();
    })();
  </script>
</body>
</html>
