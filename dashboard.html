<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema DOT Moreira - Painel</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="app.js"></script>
</head>
<body>
  <div id="topbar"></div>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h2>Bem-vindo(a)</h2>
        <div id="meBox" class="small">Carregando…</div>
        <div class="row" style="margin-top:10px;">
          <span class="badge" id="roleBadge">role</span>
          <span class="badge green" id="uidBadge">uid</span>
        </div>
      </div>

      <div class="card">
        <h2>Resumo (tempo real)</h2>
        <div class="small" id="stats">Carregando…</div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Avisos DOT</h2>
      <div id="notices">Carregando…</div>
    </div>
  </div>

  <script>
    let state = { me: null, user: null };

    (async function(){
      renderTopbar("dashboard");
      const { user, me } = await requireAuth();
      state.me = me; state.user = user;

      // aplica convite se houver
      await applyInviteIfExists(me);
      const me2 = (await db.collection("users").doc(user.uid).get()).data();
      state.me = me2;

      $("#meBox").innerHTML = `
        <b>Nome:</b> ${me2.name || "(sem nome)"}<br/>
        <b>Email:</b> ${me2.email || "-"}<br/>
      `;
      $("#roleBadge").innerText = "Roles: " + (me2.roles || []).join(", ");
      $("#uidBadge").innerText = "UID: " + me2.uid;

      // Contadores em tempo real
      db.collection("students").onSnapshot((snap)=>{
        const total = snap.size;
        $("#stats").innerHTML = `<b>Total de alunos:</b> ${total}`;
      });

      db.collection("notices").orderBy("createdAt","desc").limit(10)
        .onSnapshot((snap)=>{
          const arr = snap.docs.map(d => d.data());
          $("#notices").innerHTML = arr.length ? arr.map(n => `
            <div style="padding:10px 0;border-bottom:1px solid #e5e7eb">
              <b>${n.title}</b><br/>
              <span class="small">${n.message}</span>
            </div>
          `).join("") : `<span class="small">Sem avisos.</span>`;
        });
    })();
  </script>
</body>
</html>
