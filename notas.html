<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema DOT Moreira - Notas/PDF</title>
  <link rel="stylesheet" href="styles.css" />

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script src="firebase.js"></script>
  <script src="app.js"></script>
</head>
<body>
  <div id="topbar"></div>
  <div class="container">

    <div class="card">
      <h2>Lançar notas e enviar boletim em PDF (pais)</h2>

      <div class="field">
        <label>Aluno</label>
        <select id="student"></select>
      </div>

      <div class="field">
        <label>Bimestre</label>
        <select id="bim">
          <option value="1">1º</option>
          <option value="2">2º</option>
          <option value="3">3º</option>
          <option value="4">4º</option>
        </select>
      </div>

      <div class="grid">
        <div class="field">
          <label>Nota 1</label>
          <input id="n1" type="number" step="0.1" />
        </div>
        <div class="field">
          <label>Nota 2</label>
          <input id="n2" type="number" step="0.1" />
        </div>
      </div>

      <div class="field">
        <label>Média</label>
        <input id="media" type="number" step="0.1" />
      </div>

      <button class="btn primary" onclick="save()">Salvar notas</button>

      <hr style="border:0;border-top:1px solid #e5e7eb;margin:14px 0"/>

      <div class="field">
        <label>PDF do boletim (opcional)</label>
        <input id="pdf" type="file" accept="application/pdf" />
      </div>
      <button class="btn primary" onclick="upload()">Enviar PDF</button>

      <p class="small" id="msg"></p>
    </div>

  </div>

  <script>
    let state = { me:null, user:null, students:[] };

    async function loadStudents(){
      state.students = await listStudents();
      $("#student").innerHTML = state.students.map(s => `<option value="${s.id}">${s.name} (${s.turma})</option>`).join("");
    }

    async function save(){
      try{
        $("#msg").innerText = "Salvando…";
        await saveGrades(
          $("#student").value,
          $("#bim").value,
          $("#n1").value,
          $("#n2").value,
          $("#media").value,
          state.me
        );
        $("#msg").innerText = "✅ Notas salvas!";
      }catch(e){
        $("#msg").innerText = "❌ " + e.message;
      }
    }

    async function upload(){
      try{
        $("#msg").innerText = "Enviando PDF…";
        const file = $("#pdf").files[0];
        const url = await uploadReportPdf($("#student").value, $("#bim").value, file, state.me);
        $("#msg").innerHTML = `✅ PDF enviado! <a href="${url}" target="_blank">Abrir PDF</a>`;
      }catch(e){
        $("#msg").innerText = "❌ " + e.message;
      }
    }

    (async function(){
      renderTopbar("notas");
      const { user, me } = await requireAuth();
      state.user=user; state.me=me;
      await loadStudents();
    })();
  </script>
</body>
</html>
